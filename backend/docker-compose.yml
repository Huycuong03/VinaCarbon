services:
  traefik:
    image: traefik:v2.11
    container_name: traefik
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  search-service:
    build:
      context: ./search
    container_name: search-service
    env_file:
      - .env
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.search.rule=PathPrefix(`/search`)"
      - "traefik.http.routers.search.middlewares=search-strip"
      - "traefik.http.middlewares.search-strip.stripprefix.prefixes=/search"
      - "traefik.http.services.search.loadbalancer.server.port=80"

  assistant-service:
    build:
      context: ./assistant
    container_name: assistant-service
    env_file:
      - .env
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.assistant.rule=PathPrefix(`/assistant`)"
      - "traefik.http.routers.assistant.middlewares=assistant-strip"
      - "traefik.http.middlewares.assistant-strip.stripprefix.prefixes=/assistant"
      - "traefik.http.services.assistant.loadbalancer.server.port=80"

  community-service:
    build:
      context: ./community
    container_name: community-service
    env_file:
      - .env
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.community.rule=PathPrefix(`/community`)"
      - "traefik.http.routers.community.middlewares=community-strip"
      - "traefik.http.middlewares.community-strip.stripprefix.prefixes=/community"
      - "traefik.http.services.community.loadbalancer.server.port=80"

  biomass-service:
    build:
      context: ./biomass
    container_name: biomass-service
    env_file:
      - .env
    volumes:
      - ./preliminary-biomass-estimation.tif:/app/preliminary-biomass-estimation.tif
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.biomass.rule=PathPrefix(`/biomass`)"
      - "traefik.http.routers.biomass.middlewares=biomass-strip"
      - "traefik.http.middlewares.biomass-strip.stripprefix.prefixes=/biomass"
      - "traefik.http.services.biomass.loadbalancer.server.port=80"
